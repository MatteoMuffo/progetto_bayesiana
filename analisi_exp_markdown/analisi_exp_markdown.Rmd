---
title: "Glaucoma Structural Progression"
author: "Davide Burba, Matteo Muffo"
date: "December 1, 2017"
output: 
  beamer_presentation:
    keep_tex: yes
    theme: Warsaw
    colortheme: "seahorse"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```



```{r include=FALSE}

setwd("~/Documents/universita/bayesian_statistics-Guglielmi/GLAUCOMA_PROJECT/src/analisi_exp_markdown/")

##################################################################
####################### LOADING DATA  ############################
##################################################################


# Gdata=read.table("../../data/data.csv", header=T,fill=T,sep=",")
# 
# 
# attach(Gdata)
# 
# # BUILDING A TIME VARIABLE (MINIMUM AGE=0 for each patient)
# time= numeric(506)
# for (i in unique(Patient))
# {
#   tmp=Gdata[Patient==i,]
#   index=which(Patient==i)
#   minage=min(tmp$Age)
#   time[index]=tmp$Age-minage
# }
# 
# #adding time to Gdata
# Gdata=cbind(Gdata,time)
# Gdata$time
# 
# 
# 
# 
# #Save the data.frame
# save (Gdata, file="../../R_object/Glaucoma_data.RData")

load("../../R_object/Glaucoma_data.RData")

attach(Gdata)




dim(Gdata)
length(unique(Patient)) # 115 pazienti

```

## EXPLORATORY ANALYSIS
- Number of visits per patient


```{r echo=FALSE, fig.height=4, fig.width=14}
##################################################################
##################### DATA VISUALIZATION  ########################
##################################################################
                           
library(ggplot2)

# patient
ggplot(data= Gdata, aes(factor(Patient), fill=1) ) + 
  geom_bar()+
  theme(legend.position = "none", axis.text.x  = element_text(angle=90, hjust=1, vjust=0.9)) +
  geom_hline(yintercept = mean(mean(table(Patient))), color="red")

```

```{r include=FALSE}
#numero visite per paziente:
N=mean(table(Patient))
N
quantile(table(Patient),0.25)
quantile(table(Patient),0.5)
quantile(table(Patient),0.75)
```
- Mean number of observations: 9.2
- 0.25 quantile: 9
- 0.50 quantile: 11
- 0.75 quantile: 11


##

- female vs male

```{r echo=FALSE, fig.height=4, fig.width=4}

#female vs male
ggplot(data= Gdata, aes(Sex, fill=Sex  ) ) + 
  geom_bar()+
  theme(legend.position = "none", axis.text.x  = element_text(angle=0, hjust=1, vjust=0.9)) 
```

##
- type of glaucoma

```{r echo=FALSE , fig.height=4, fig.width=14}

# type of glaucoma
ggplot(data= Gdata, aes(Type_of_glaucoma, fill=Type_of_glaucoma  ) ) + 
  geom_bar()+
  theme(legend.position = "none", axis.text.x  = element_text(angle=0.45, hjust=1, vjust=0.9)) 
```



## FAMILY HISTORY


```{r echo=FALSE , fig.height=6, fig.width=8,  message=FALSE, warning=FALSE}



bar <- ggplot(data= Gdata, aes(x = factor(1), fill = family_history)) + geom_bar(width = 1)

counts=as.numeric(table(family_history))

pie <- bar + coord_polar(theta = "y") + theme_void() #+ 
  #geom_text(aes(y=family_history, label=scales::percent(counts)))
pie
```

```{r eval=FALSE, include=FALSE}

### NOT SURE THOSE ARE IMPORTANT -> HIDDEN AT THIS MOMENT

# sup_10thpercent
ggplot(data= Gdata, aes( sup_10thpercent )  ) + 
  geom_histogram(col="white", 
                 fill="blue",
                 binwidth = 10) +
  ylab("relative frequencies") + 
  scale_y_continuous(labels=scales::percent) +
  geom_bar()+
  theme(legend.position = "none", axis.text.x  = element_text(angle=0, hjust=1, vjust=0.9)) 


# sup_25thpercent
ggplot(data= Gdata, aes( sup_25thpercent )  ) + 
  geom_histogram(col="white", 
                 fill="blue",
                 binwidth = 25) +
  ylab("relative frequencies") + 
  scale_y_continuous(labels=scales::percent) +
  geom_bar()+
  theme(legend.position = "none", axis.text.x  = element_text(angle=0, hjust=1, vjust=0.9)) 

# Periph
ggplot(data= Gdata, aes(factor(Periph), fill=factor(Periph) ) ) + 
  geom_bar()+
  theme(legend.position = "none", axis.text.x  = element_text(angle=0, hjust=1, vjust=0.9)) 

```




```{r include=FALSE, fig.height=2, fig.width=6}


###### Proviamo a "visualizzare" un unico paziente

Paz=590
Gdata_paz=Gdata[Patient==Paz,]
dim(Gdata_paz)

#qualche variabile: 
Gdata_paz$yearofglaucoma
Gdata_paz$Color
Gdata_paz$Periph
Gdata_paz$Visit
Gdata_paz$Progression
Gdata_paz$Progression1
Gdata_paz$ProgressionStructure1
Gdata_paz$ProgressionStructure
Gdata_paz
Gdata_paz$Age # variabile tempo!
Gdata_paz$age65
Gdata_paz$visualizationofON
Gdata_paz$MAP
Gdata_paz$FieldsComment
Gdata_paz$Field2
Gdata_paz$acuity





#MODIFICHE STRUTTURALI (riguardo al nervo ottico)
#RNFL
Gdata_paz$RNFL_average 
Gdata_paz$RNFL_cross_sectinal_area
Gdata_paz$RNFL_Multi_G_center
Gdata_paz$RNFL_Multi_Nasal
Gdata_paz$RNFL_Multi_Temp
Gdata_paz$RNFL_Multi_NI
Gdata_paz$RNFL_Multi_NS
Gdata_paz$RNFL_Multi_TI
Gdata_paz$RNFL_Multi_TS
Gdata_paz$RNFL_quad_Inf
Gdata_paz$RNFL_quad_nasal
Gdata_paz$RNFL_quad_Sup
Gdata_paz$RNFL_quad_temp
Gdata_paz$RNFL_thickness_superior
Gdata_paz$RNFL_thickness_inferior
Gdata_paz$RNFL_thickness_nasal
Gdata_paz$RNFL_thickness_temporal
Gdata_paz$OCT_RNFL_Signal_Strength
Gdata_paz$mean_RNFL_thickness
#RIM
Gdata_paz$Rim_area
Gdata_paz$RimArea
Gdata_paz$rim_volume
#CUP DISK
cup_disk_horiz_ratio
cup_disk_vert_ratio
linear_cup_disc_ratio


#MODIFICHE FUNZIONALI 
Gdata_paz$MD # Deviazione media CAMPO VISIVO!
Gdata_paz$PSD #Pattern Standard Deviation, nel perimetro Humphrey

```




## RNFL average


```{r echo=FALSE , fig.height=4, fig.width=8,  message=FALSE, warning=FALSE}


## define base for the graphs and store in object 'p'
p <- ggplot(data = Gdata[!is.na(RNFL_average),], aes(x = time, y = RNFL_average,  color= factor(Patient) )  )



p + geom_line() + geom_point() +
     geom_smooth(method = lm, color="black")  

p <- ggplot(data = Gdata[!is.na(RNFL_average)& time<2,], aes(x = time, y = RNFL_average,  color= factor(Patient) )  )

p + geom_line() + geom_point() +
     geom_smooth(method = lm, color="black") 

```


## RNFL average

- By Sex

```{r echo=FALSE , fig.height=5, fig.width=10,  message=FALSE, warning=FALSE}

p <- ggplot(data = Gdata[!is.na(RNFL_average) &!is.na(Sex),], aes(x = time, y = RNFL_average,  color= factor(Patient) )  )

p + geom_line() + geom_point()  +
     geom_smooth(method = lm, color="black") +
     facet_grid(. ~ Sex)

```


## RNFL average

- Only POAG Glaucoma

```{r echo=FALSE , fig.height=5, fig.width=10 ,  message=FALSE, warning=FALSE}


p=ggplot(data = Gdata[Type_of_glaucoma=="POAG",], aes(x = time, y = RNFL_average, color= factor(Patient)))

p + geom_line() + geom_point() +
     geom_smooth(method = lm, color="black")  +
     stat_summary(aes(group = 1), fun.y = mean, shape = 17, size = 0.5) 

```




## RIM area


```{r echo=FALSE , fig.height=4, fig.width=8,  message=FALSE, warning=FALSE}


## define base for the graphs and store in object 'p'
p <- ggplot(data = Gdata[!is.na(Rim_area),], aes(x = time, y = Rim_area,  color= factor(Patient) )  )



p + geom_line() + geom_point() +
     geom_smooth(method = lm, color="black")  

p <- ggplot(data = Gdata[!is.na(Rim_area)& time<2,], aes(x = time, y = Rim_area,  color= factor(Patient) )  )

p + geom_line() + geom_point() +
     geom_smooth(method = lm, color="black")  

```

## RIM area

- By Sex

```{r echo=FALSE , fig.height=5, fig.width=10,  message=FALSE, warning=FALSE}

p <- ggplot(data = Gdata[!is.na(Rim_area) &!is.na(Sex),], aes(x = time, y = Rim_area,  color= factor(Patient) )  )

p + geom_line() + geom_point()  +
     geom_smooth(method = lm, color="black") +
     facet_grid(. ~ Sex)

```





##  MD


```{r echo=FALSE , fig.height=4, fig.width=8,  message=FALSE, warning=FALSE}


## define base for the graphs and store in object 'p'
p <- ggplot(data = Gdata[!is.na(MD),], aes(x = time, y = MD,  color= factor(Patient) )  )



p + geom_line() + geom_point() +
     geom_smooth(method = lm, color="black")  


```



##  PSD


```{r echo=FALSE , fig.height=4, fig.width=8,  message=FALSE, warning=FALSE}


## define base for the graphs and store in object 'p'
p <- ggplot(data = Gdata[!is.na(PSD),], aes(x = time, y = PSD,  color= factor(Patient) )  )



p + geom_line() + geom_point() +
     geom_smooth(method = lm, color="black")  


```



## RNFL vs MD (structural vs functional)


```{r echo=FALSE , fig.height=4, fig.width=8,  message=FALSE, warning=FALSE}


## define base for the graphs and store in object 'p'
p4 <- ggplot(data = Gdata[!is.na(MD) & !is.na(RNFL_average),], aes(x = MD, y = RNFL_average, color= factor(Patient) )  )



p4  + geom_point() +
       geom_smooth(method = lm, color="black")


```

## RNFL vs PSD (structural vs functional)


```{r echo=FALSE , fig.height=4, fig.width=8,  message=FALSE, warning=FALSE}


## define base for the graphs and store in object 'p'
p5 <- ggplot(data = Gdata[!is.na(PSD) & !is.na(RNFL_average),], aes(x = PSD, y = RNFL_average,  color= factor(Patient) )  )



p5 + geom_line() + geom_point() +
     stat_smooth(aes(group = 1)) +
     geom_smooth(method = lm, color="black") 


```

## RNFL vs RIM (structural vs structural)


```{r echo=FALSE , fig.height=4, fig.width=8,  message=FALSE, warning=FALSE}


## define base for the graphs and store in object 'p'
p6 <- ggplot(data = Gdata[!is.na(Rim_area) & !is.na(RNFL_average),], aes(x = Rim_area, y = RNFL_average, color= factor(Patient) )  )



p6 + geom_line() + geom_point() +
       geom_smooth(method = lm, color="black")


```

## MD vs PSD (functional vs functional)


```{r echo=FALSE , fig.height=4, fig.width=8,  message=FALSE, warning=FALSE}


## define base for the graphs and store in object 'p'
p7 <- ggplot(data = Gdata[!is.na(MD) & !is.na(PSD),], aes(x = MD, y = PSD   )  )



p7 +   geom_line( aes( color= factor(Patient)) ) +
       geom_point(aes( color= factor(Patient)) ) +
       geom_smooth(method = lm, color="black")


```



##
```{r include=FALSE, fig.height=14, fig.width=12,  message=FALSE, warning=FALSE}
#PROVA PCA

ST_data=cbind(
RNFL_average ,
#RNFL_cross_sectinal_area,
#RNFL_thickness_superior,
#RNFL_thickness_inferior,
#RNFL_thickness_nasal,
#RNFL_thickness_temporal,
#OCT_RNFL_Signal_Strength,
mean_RNFL_thickness,
Rim_area,
#RimArea,
rim_volume,
linear_cup_disc_ratio,
time)
head(ST_data)
#tolgo tempi "strani"

ST_data=ST_data[-c(209,210,211),]
ST_data=data.frame(ST_data)

tmin=min(ST_data$time)
tmax=max(ST_data$time)

n=8
time_int=c(0:n)/n*tmax
mSTdata=NULL
for (i in 2:(n+1))
{
  mSTdata=rbind (mSTdata, colMeans( ST_data[   ST_data$time>=time_int[i-1] &  ST_data$time<time_int[i] , ]     , na.rm=TRUE)   )
}
#mSTdata

mSTdata=data.frame(mSTdata)

p <- ggplot(data = mSTdata, aes(x = time, y = RNFL_average  )  )

p +    geom_line(  ) +
       geom_point() +
       geom_smooth(method = lm)

p2 <- ggplot(data = mSTdata, aes(x = time, y = Rim_area  )  )

p2 +    geom_line(  ) +
       geom_point() +
       geom_smooth(method = lm)


#myfile.sd <- scale(mSTdata[,1:5])  #standardizzo i dati e faccio pca su questa
myfile.sd <- mSTdata[,1:5]
myfile.sd <- data.frame(myfile.sd)
pc.myfile <- princomp(myfile.sd, scores=T)
summary(pc.myfile)

load.myfile    <- pc.myfile$loadings
load.myfile


par(mar = c(1,4,0,2), mfrow = c(5,1))
for(i in 1:5)barplot(load.myfile[,i], ylim = c(-1, 1))

#sembra che prima component: thickness e cup, seconda: rim e rnfl

```



```{r}
## define base for the graphs and store in object 'p'
p <- ggplot(data = Gdata[!is.na(cup_disk_vert_ratio),], aes(x = time, y = cup_disk_vert_ratio,  color= factor(Patient) )  )



p + geom_line() + geom_point() +
     geom_smooth(method = lm, color="black") 
```




 
 
 
 